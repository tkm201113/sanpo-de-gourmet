<!DOCTYPE html>
<html>
<head>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAX9Be4_3dwav-hf9Xqsob1S0sBcgEUBUY&libraries=places,marker&callback=initMap" async defer></script>
  <script>
    function initMap() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
          var currentLocation = {
            lat: position.coords.latitude,
            lng: position.coords.longitude
          };

          var map = new google.maps.Map(document.getElementById('map'), {
            zoom: 14,
            center: currentLocation
          });

          var marker = new google.maps.Marker({
            position: currentLocation,
            map: map
          });

          var request = {
            location: currentLocation,
            radius: '500',
            type: ['restaurant']
          };

          var service = new google.maps.places.PlacesService(map);
          service.nearbySearch(request, function(results, status) {
            if (status === google.maps.places.PlacesServiceStatus.OK) {
              var restaurantList = document.getElementById('restaurant-list');
              restaurantList.innerHTML = ''; // 既存のリストをクリア

              results.forEach(function(place) {
                var listItem = document.createElement('div');
                listItem.className = 'restaurant-item';
                listItem.innerHTML = '<h3>' + place.name + '</h3><p>' + place.vicinity + '</p>';
                listItem.addEventListener('click', function() {
                  window.location.href = '/restaurants/' + place.place_id; // 店舗詳細ページへのリダイレクト
                });
                restaurantList.appendChild(listItem);
              });
            } else {
              console.error('PlacesServiceStatus Error:', status);
            }
          });
        });
      } else {
        alert("Geolocation is not supported by this browser.");
      }
    }
  </script>
  <style>
    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 0;
      padding: 0;
      height: 100vh;
      overflow-y: auto;
    }

    #map {
      height: 400px;
      width: 60%;
      margin: 20px 0;
    }

    #restaurant-list-container {
      background-color: white;
      border: 2px solid black;
      border-radius: 10px;
      padding: 20px;
      width: 60%;
      max-height: 200px;
      overflow-y: scroll;
      margin-bottom: 20px;
    }

    .restaurant-item {
      background-color: #f8f8f8;
      border: 1px solid #ddd;
      border-radius: 5px;
      padding: 10px;
      margin-bottom: 10px;
      cursor: pointer;
    }

    .restaurant-item h3 {
      margin: 0;
      font-size: 1.2em;
    }

    .restaurant-item p {
      margin: 5px 0 0;
      font-size: 1em;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <div id="restaurant-list-container">
    <div id="restaurant-list">
      <% @restaurants.each do |restaurant| %>
        <div class="restaurant-item" onclick="window.location.href='/restaurants/<%= restaurant[:id] %>';">
          <h3><%= restaurant[:name] %></h3>
          <p><%= restaurant[:address] %></p>
        </div>
      <% end %>
    </div>
  </div>
</body>
</html>